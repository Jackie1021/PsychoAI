rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is a moderator
    function isModerator() {
      return isAuthenticated() && request.auth.token.role == 'moderator';
    }
    
    // Helper function to check if user has blocked another user
    function hasBlocked(userId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/blocks/$(userId));
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Users can create or update their own profile document
      allow create, update: if isOwner(userId);
      
      // Users cannot delete their own profile
      allow delete: if false;
      
      // Blocks subcollection - only accessible by the owner
      match /blocks/{blockedUid} {
        allow read, write, delete: if isOwner(userId);
      }

      // Likes subcollection storing the user -> post mapping
      match /likes/{postId} {
        allow read, write, delete: if isOwner(userId);
      }

      // Favorites subcollection storing the user -> post mapping
      match /favorites/{postId} {
        allow read, write, delete: if isOwner(userId);
      }

      // Following relationships (current user following others)
      match /following/{targetUid} {
        allow read, write, delete: if isOwner(userId);
      }

      // Followers subcollection (other users following current user)
      match /followers/{followerUid} {
        // Owner can read follower list; writes handled by cloud functions
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Match records subcollection - user's match history
      match /matchRecords/{recordId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if false; // Don't allow deleting history
      }
      
      // Match reports subcollection - cached reports
      match /matchReports/{reportId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only Cloud Functions can write
      }
      
      // Yearly analyses subcollection - cached AI analyses
      match /yearlyAnalyses/{analysisId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId); // Allow user to cache their own analyses
      }
      
      // Subscriptions subcollection - only owner can read
      match /subscriptions/{subscriptionId} {
        allow read: if isOwner(userId);
        // Only Cloud Functions can write subscriptions
        allow write: if false;
      }
    }
    
    // Posts collection
    match /posts/{postId} {
      // Allow read if:
      // 1. User is authenticated
      // 2. Post is visible (not hidden or removed)
      // 3. User hasn't blocked the post author (only if userId exists)
      allow read: if isAuthenticated()
        && resource.data.status == 'visible'
        && (
          !('userId' in resource.data) ||
          resource.data.userId == null ||
          (resource.data.userId is string && !hasBlocked(resource.data.userId))
        );
      
      // Users can create their own posts
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // Users can update/delete their own posts
      allow update, delete: if isOwner(resource.data.userId);
      
      // Likes subcollection
      match /likes/{userId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }

      // Comments subcollection: enforce ownership and visibility
      match /comments/{commentId} {
        // Allow read for authenticated users if comment is visible
        allow read: if isAuthenticated();

        // Allow create for authenticated users with valid data
        allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 2000;

        // Allow update/delete only by owner
        allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
        
        // Comment likes subcollection
        match /likes/{likeUserId} {
          allow read: if isAuthenticated();
          allow create, delete: if isAuthenticated() && likeUserId == request.auth.uid;
        }
      }
    }
    
    // Reports collection - write-only for regular users
    match /reports/{reportId} {
      // Users can submit reports
      allow create: if isAuthenticated() 
        && request.resource.data.reporterId == request.auth.uid;
      
      // Only moderators can read reports
      allow read, update, delete: if isModerator();
    }
    
    // Moderation queue - moderator only
    match /moderationQueue/{queueId} {
      allow read, write: if isModerator();
    }
    
    // Audit logs - moderator read-only
    match /auditLogs/{logId} {
      allow read: if isModerator();
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // Matches collection - users can read their own matches
    match /matches/{userId}/candidates/{candidateId} {
      allow read: if isOwner(userId);
      // Only Cloud Functions can write matches
      allow write: if false;
    }
    
    // Conversations - users can read/write their own conversations
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() 
        && request.auth.uid in resource.data.participantIds;
      
      allow create: if isAuthenticated() 
        && request.auth.uid in request.resource.data.participantIds
        && request.resource.data.participantIds is list
        && request.resource.data.participantIds.size() >= 2;
      
      allow update: if isAuthenticated() 
        && request.auth.uid in resource.data.participantIds;
      
      allow delete: if isAuthenticated() 
        && request.auth.uid in resource.data.participantIds;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        
        // Allow create if:
        // 1. User is authenticated
        // 2. Either senderId is 'system' (system messages don't need participant check) OR user is the sender and participant
        // For system messages, skip the conversation document check to avoid race conditions
        allow create: if isAuthenticated()
          && (
            // System messages can be created without checking conversation document
            request.resource.data.senderId == 'system' ||
            // Regular messages require sender to be a participant
            (
              request.resource.data.senderId == request.auth.uid
              && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds
            )
          );
        
        allow update: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        
        allow delete: if isAuthenticated()
          && request.auth.uid == resource.data.senderId;
      }
    }
    
    // Profile Cards - public with privacy controls
    match /profileCards/{userId} {
      // Allow read if authenticated and either:
      // 1. It's the user's own card, or
      // 2. The card allows stranger access
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        resource.data.privacy.allowStrangerAccess == true
      );

      // Only owner can write their profile card
      allow create, update: if isOwner(userId);
      allow delete: if false; // Don't allow deleting profile cards

      // Profile card settings subcollection - only owner can access
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Profile Card Views - track viewing history
    match /profileCardViews/{userId}/daily/{date} {
      allow read, write: if isOwner(userId);
    }
    
    match /profileCardViews/{userId}/history/{viewId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated(); // Any authenticated user can record views
      allow update, delete: if false;
    }
    
    // Privacy Settings - only accessible by owner
    match /users/{userId}/private/privacy_settings {
      allow read, write: if isOwner(userId);
    }
  }
}
